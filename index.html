<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Relevance Matcher</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border-top-color: #a78bfa; }
    </style>
</head>
<body class="bg-slate-950 text-gray-100 min-h-screen p-4 sm:p-6 md:p-12 flex justify-center items-start">
    <div class="max-w-7xl w-full flex flex-col items-center">
        <header class="text-center mb-10 w-full">
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-white">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-indigo-600">AI Resume</span> Matcher
            </h1>
            <p class="mt-3 text-lg text-gray-400 max-w-3xl mx-auto">
                Intelligently score, rank, and get feedback on resumes against any job description.
            </p>
        </header>

        <div class="w-full grid grid-cols-1 lg:grid-cols-3 gap-8" id="main-content-grid">
            <div id="jdPanel" class="bg-slate-900 p-6 rounded-2xl shadow-2xl flex flex-col border border-slate-700">
                <h2 class="text-2xl font-bold mb-4 text-purple-300">1. Job Description</h2>
                <div class="flex-grow flex flex-col">
                    <p class="text-gray-400 mb-4 text-sm">Upload a job description file or paste its content below.</p>
                    <input type="file" id="jdFileInput" accept=".pdf,.docx,.txt" class="mb-4 block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer">
                    <textarea id="jdTextArea" rows="10" class="flex-grow block p-3 w-full text-sm text-gray-100 bg-slate-800 rounded-lg border border-slate-700 focus:ring-purple-500 focus:border-purple-500" placeholder="Or paste job description here..."></textarea>
                </div>
                <button id="processJdBtn" class="mt-6 w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:scale-105 transition-transform">
                    Process Job Description
                </button>
            </div>

            <div id="dashboardPanel" class="bg-slate-900 p-6 rounded-2xl shadow-2xl flex flex-col lg:col-span-2 border border-slate-700">
                <h2 id="dashboardTitle" class="text-2xl font-bold mb-4 text-purple-300">2. Analysis Dashboard</h2>
                <div id="analysis-UI" class="flex-grow flex flex-col">
                    <!-- Initial State -->
                    <div id="initialState" class="text-center text-gray-400 m-auto">
                        <p class="text-lg">Process a Job Description to begin.</p>
                        <p class="text-sm mt-2">Once processed, you will be able to upload resumes for analysis.</p>
                    </div>

                    <!-- Resume Upload State -->
                    <div id="resumeUploadState" class="hidden flex-grow flex flex-col">
                        <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700 mb-4">
                            <h3 class="font-bold text-white mb-2">Job Description Processed!</h3>
                            <p class="text-sm text-gray-300">Now, upload one or more resumes to analyze against the JD.</p>
                        </div>
                        <input type="file" id="resumeFileInput" accept=".pdf,.docx" multiple class="mb-4 block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer">
                        <button id="analyzeAllBtn" disabled class="w-full bg-gray-500 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            Select Resumes to Analyze
                        </button>
                    </div>

                     <!-- Analysis In Progress State -->
                    <div id="loadingState" class="hidden flex-grow flex flex-col">
                        <div id="progress-bar-container" class="w-full bg-slate-700 rounded-full h-2.5 mb-4">
                            <div id="progress-bar" class="bg-purple-500 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <div class="text-center text-gray-300">
                            <p id="progress-text" class="font-semibold"></p>
                            <p id="progress-file-name" class="text-sm text-gray-400 truncate"></p>
                        </div>
                    </div>
                </div>

                <!-- Results Table Area -->
                <div id="resultsState" class="hidden flex-col h-full mt-4">
                     <div class="overflow-x-auto rounded-lg">
                        <table class="min-w-full bg-slate-800">
                            <thead class="bg-slate-700">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Resume File</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Score</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Verdict</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Missing Skills</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Candidate Email</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Suggestions</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody" class="divide-y divide-slate-700">
                                <!-- Results will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <button id="startOverBtn" class="mt-6 w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:scale-105 transition-transform">
                        Start New Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl text-center max-w-sm border border-slate-600">
            <h3 id="messageTitle" class="text-xl font-bold mb-2 text-white"></h3>
            <p id="messageText" class="text-gray-300 mb-4"></p>
            <button id="closeMessageBtn" class="bg-indigo-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-600">OK</button>
        </div>
    </div>

    <script>
        const jdFileInput = document.getElementById('jdFileInput');
        const jdTextArea = document.getElementById('jdTextArea');
        const processJdBtn = document.getElementById('processJdBtn');
        const resumeFileInput = document.getElementById('resumeFileInput');
        const analyzeAllBtn = document.getElementById('analyzeAllBtn');
        const startOverBtn = document.getElementById('startOverBtn');
        
        const initialState = document.getElementById('initialState');
        const resumeUploadState = document.getElementById('resumeUploadState');
        const loadingState = document.getElementById('loadingState');
        const resultsState = document.getElementById('resultsState');
        const resultsTableBody = document.getElementById('resultsTableBody');

        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressFileName = document.getElementById('progress-file-name');

        const messageBox = document.getElementById('messageBox');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const closeMessageBtn = document.getElementById('closeMessageBtn');

        let jobDescriptionData = null;
        const API_URL = '/api';

        function showMessage(title, message) {
            messageTitle.textContent = title;
            messageText.textContent = message;
            messageBox.style.display = 'flex';
        }

        closeMessageBtn.addEventListener('click', () => { messageBox.style.display = 'none'; });

        processJdBtn.addEventListener('click', () => {
            if (jdTextArea.value.trim() === '' && jdFileInput.files.length === 0) {
                showMessage('Input Required', 'Please upload or paste a job description.');
                return;
            }
            if (jdFileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = e => { jobDescriptionData = e.target.result; };
                reader.readAsDataURL(jdFileInput.files[0]);
            } else {
                jobDescriptionData = jdTextArea.value;
            }
            initialState.classList.add('hidden');
            resumeUploadState.classList.remove('hidden');
            processJdBtn.disabled = true;
            jdTextArea.disabled = true;
            jdFileInput.disabled = true;
        });

        resumeFileInput.addEventListener('change', () => {
            if (resumeFileInput.files.length > 0) {
                analyzeAllBtn.disabled = false;
                analyzeAllBtn.textContent = `Analyze ${resumeFileInput.files.length} Resume(s)`;
                analyzeAllBtn.classList.replace('bg-gray-500', 'bg-indigo-600');
            } else {
                analyzeAllBtn.disabled = true;
                analyzeAllBtn.textContent = 'Select Resumes to Analyze';
                analyzeAllBtn.classList.replace('bg-indigo-600', 'bg-gray-500');
            }
        });

        analyzeAllBtn.addEventListener('click', async () => {
            const resumeFiles = Array.from(resumeFileInput.files);
            if (!jobDescriptionData || resumeFiles.length === 0) {
                showMessage('Files Missing', 'Please ensure a JD is processed and resumes are selected.');
                return;
            }

            resumeUploadState.classList.add('hidden');
            loadingState.classList.remove('hidden');
            resultsState.classList.remove('hidden');
            resultsTableBody.innerHTML = '';

            for (let i = 0; i < resumeFiles.length; i++) {
                const file = resumeFiles[i];
                const percentage = Math.round(((i + 1) / resumeFiles.length) * 100);
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `Analyzing ${i + 1} of ${resumeFiles.length}...`;
                progressFileName.textContent = file.name;

                try {
                    const content = await readFileAsDataURL(file);
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            job_description: jobDescriptionData,
                            resume: { fileName: file.name, content: content }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    appendResultToTable(result);

                } catch (error) {
                    console.error('Error analyzing file:', file.name, error);
                    const errorResult = {
                        resumeName: file.name, score: 'N/A', verdict: 'Error',
                        candidateEmail: 'N/A',
                        missingSkills: ['Analysis Failed'], suggestions: error.message
                    };
                    appendResultToTable(errorResult);
                }
            }
            loadingState.classList.add('hidden');
        });

        function appendResultToTable(result) {
            let verdictColor = 'text-gray-400';
            if (result.verdict === 'High') verdictColor = 'text-green-400';
            else if (result.verdict === 'Medium') verdictColor = 'text-yellow-400';
            else if (result.verdict === 'Low') verdictColor = 'text-red-400';

            const missingSkillsHtml = Array.isArray(result.missingSkills) && result.missingSkills.length > 0
                ? result.missingSkills.map(s => `<li>${s}</li>`).join('')
                : '<li>None</li>';

            const suggestionsHtml = result.suggestions.replace(/\n/g, '<br>');

            const row = document.createElement('tr');
            row.className = 'hover:bg-slate-700/50';
            row.innerHTML = `
                <td class="py-3 px-4 text-sm font-medium text-gray-300">${result.resumeName}</td>
                <td class="py-3 px-4 text-sm font-bold text-white">${result.score}</td>
                <td class="py-3 px-4 text-sm font-semibold ${verdictColor}">${result.verdict}</td>
                <td class="py-3 px-4 text-sm text-gray-400"><ul class="list-disc list-inside">${missingSkillsHtml}</ul></td>
                <td class="py-3 px-4 text-sm text-blue-400">${result.candidateEmail}</td>
                <td class="py-3 px-4 text-sm text-gray-400">${suggestionsHtml}</td>
            `;
            resultsTableBody.appendChild(row);
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        startOverBtn.addEventListener('click', () => {
            jobDescriptionData = null;
            jdFileInput.value = '';
            jdTextArea.value = '';
            resumeFileInput.value = '';
            
            processJdBtn.disabled = false;
            jdTextArea.disabled = false;
            jdFileInput.disabled = false;

            resumeUploadState.classList.add('hidden');
            loadingState.classList.add('hidden');
            resultsState.classList.add('hidden');
            initialState.classList.remove('hidden');

            analyzeAllBtn.disabled = true;
            analyzeAllBtn.textContent = 'Select Resumes to Analyze';
            analyzeAllBtn.classList.replace('bg-indigo-600', 'bg-gray-500');
            resultsTableBody.innerHTML = '';
        });
    </script>
</body>
</html>

